<%=
config = {
    "address" => p('address'),
    "port" => "#{p('port')}"
}


nats_machines = nil
if_p('nats.machines') do |ips|
  nats_machines = ips.compact
end.else do
  nats_machines = link('nats').instances.map { |instance| instance.address }
end
nats_port = nil
if_p('nats.port') do |prop|
  nats_port = prop
end.else do
  nats_port = link('nats').p("nats.port")
end
nats_user = nil
if_p('nats.user') do |prop|
  nats_user = prop
end.else do
  nats_user = link('nats').p("nats.user")
end
nats_password = nil
if_p('nats.password') do |prop|
  nats_password = prop
end.else do
  nats_password = link('nats').p("nats.password")
end


nats_servers = []
nats_machines.each do |nats_machine|
    nats_servers << {
     'host' => nats_machine,
     'port' => nats_port,
     'user' => nats_user,
     'pass' => nats_password
    }
end

config['nats'] => nats_servers

require 'json'
JSON.dump(config)
%>